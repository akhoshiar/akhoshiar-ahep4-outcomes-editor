<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Module Learning Outcomes Editor (prefilled)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; max-width: 1100px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    select, input, button, textarea { font-size: 14px; padding: 8px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 14px; margin-top: 14px; }
    .muted { color: #666; }
    .pill { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; }
    .lo { display: grid; grid-template-columns: 24px 48px 1fr; gap: 10px; align-items: start; padding: 6px 0; border-bottom: 1px solid #f2f2f2;}
    .sectiontitle { margin: 0 0 8px 0; }
    .hidden { display:none; }
    .prev { background: #fafafa; border: 1px dashed #ddd; padding: 8px; border-radius: 10px; }
    .radio { display:flex; gap:10px; align-items:center; padding: 6px 10px; border: 1px solid #ddd; border-radius: 12px; }
  </style>
</head>
<body>
  <h2>Module learning outcomes editor</h2>
  <div class="intro">
  <div class="intro-title">Quick guide (AHEP4)</div>

  <ul class="intro-list">
    <li><b>Prefilled outcomes:</b> Outcomes are prefilled from the previous accreditation cycle.</li>
    <li><b>Watch first:</b> Please watch the short (≈5-minute) guidance video explaining AHEP4 requirements and the update process.</li>
    <li><b>Then update:</b> Review and update the outcomes to reflect the current module content.</li>
  </ul>

  <div class="intro-foot">
    Prefilled from <code>module_learning_outcomes.txt</code>. Choose UG or PGT, select a module, adjust outcomes, then click <b>Submit</b> to download an update file.
    <span class="muted">(This page does not write to disk by itself.)</span>
  </div>
</div>


  <div class="row">
    <label>Supervisor name:
      <input id="supervisor" placeholder="e.g., Dr Ali Hoshiar" />
    </label>

    <div class="radio" aria-label="Programme level">
      <label><input type="radio" name="level" value="UG" checked> UG</label>
      <label><input type="radio" name="level" value="PGT"> PGT</label>
    </div>

    <label>Module:
      <select id="moduleSelect"></select>
    </label>

    <span id="meta" class="pill"></span>
  </div>

  <div class="card">
    <div class="prev">
      <div class="muted">Previously recorded outcomes for this module:</div>
      <div id="previousText"><span class="muted">—</span></div>
    </div>

    <div style="height:10px"></div>

    <div id="ugBlock">
      <h3 class="sectiontitle">AHEP4 UG outcomes (C1–C18)</h3>
      <div id="c_outcomes"></div>
    </div>

    <div id="pgBlock" class="hidden">
      <h3 class="sectiontitle">AHEP4 PGT outcomes (M1–M18)</h3>
      <div id="m_outcomes"></div>
    </div>

    <div style="margin-top:12px">
      <div class="muted">Notes (optional)</div>
      <textarea id="notes" rows="4" style="width:100%" placeholder="Optional: evidence/assessment notes supporting the mapping..."></textarea>
    </div>

    <div class="row" style="margin-top:12px">
      <button id="submitBtn">Submit (download update file)</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

<script>
  const moduleSelect = document.getElementById('moduleSelect');
  const meta = document.getElementById('meta');
  const cDiv = document.getElementById('c_outcomes');
  const mDiv = document.getElementById('m_outcomes');
  const supervisorInput = document.getElementById('supervisor');
  const notesInput = document.getElementById('notes');
  const statusEl = document.getElementById('status');
  const previousText = document.getElementById('previousText');
  const ugBlock = document.getElementById('ugBlock');
  const pgBlock = document.getElementById('pgBlock');

  let modules = {};
  let currentCode = null;

  function buildLOList(prefix, n) {
    const out = [];
    for (let i=1;i<=n;i++) out.push(prefix + i);
    return out;
  }

  function renderChecklist(container, los, selectedSet) {
    container.innerHTML = los.map(lo => {
      const checked = selectedSet.has(lo) ? "checked" : "";
      return `
        <div class="lo">
          <input type="checkbox" data-lo="${lo}" ${checked}/>
          <div><b>${lo}</b></div>
          <div class="muted">[optional: add full AHEP text here]</div>
        </div>
      `;
    }).join("");
  }

  function level() {
    return document.querySelector('input[name="level"]:checked').value; // "UG" or "PGT"
  }

  function splitOutcomes(outcomes) {
    const cs = (outcomes || []).filter(x => x.startsWith("C"));
    const ms = (outcomes || []).filter(x => x.startsWith("M"));
    return {cs, ms};
  }

  function renderPrevious(outcomes) {
    if (!outcomes || !outcomes.length) {
      previousText.innerHTML = `<span class="muted">No outcomes recorded yet.</span>`;
      return;
    }
    previousText.textContent = outcomes.join(", ");
  }

  function renderModule(code) {
    currentCode = code;
    const entry = modules[code] || {outcomes: []};
    const {cs, ms} = splitOutcomes(entry.outcomes || []);
    const lvl = level();

    const prev = (lvl === "UG") ? cs : ms;
    renderPrevious(prev);

    if (lvl === "UG") {
      ugBlock.classList.remove("hidden");
      pgBlock.classList.add("hidden");
      meta.textContent = prev.length ? `${prev.length} UG outcomes prefilled` : "No UG outcomes recorded (yet)";
      renderChecklist(cDiv, buildLOList("C", 18), new Set(cs));
    } else {
      pgBlock.classList.remove("hidden");
      ugBlock.classList.add("hidden");
      meta.textContent = prev.length ? `${prev.length} PGT outcomes prefilled` : "No PGT outcomes recorded (yet)";
      renderChecklist(mDiv, buildLOList("M", 18), new Set(ms));
    }
  }

  function getSelectedFrom(container) {
    const checks = container.querySelectorAll('input[type="checkbox"][data-lo]');
    const out = [];
    checks.forEach(ch => { if (ch.checked) out.push(ch.getAttribute('data-lo')); });
    return out;
  }

  function downloadJson(obj, filename) {
    const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  moduleSelect.addEventListener('change', e => renderModule(e.target.value));
  document.querySelectorAll('input[name="level"]').forEach(r => {
    r.addEventListener('change', () => renderModule(moduleSelect.value));
  });

  document.getElementById('submitBtn').addEventListener('click', () => {
    const supervisor = supervisorInput.value.trim();
    if (!supervisor) { statusEl.textContent = "Please enter your name."; return; }

    const entry = modules[currentCode] || {outcomes: []};
    const {cs, ms} = splitOutcomes(entry.outcomes || []);

    let newCs = cs.slice();
    let newMs = ms.slice();
    if (level() === "UG") {
      newCs = getSelectedFrom(cDiv);
    } else {
      newMs = getSelectedFrom(mDiv);
    }

    const after = [...new Set([...newCs, ...newMs])];
    after.sort((a,b) => {
      const pa=a[0], pb=b[0];
      if (pa!==pb) return pa.localeCompare(pb);
      return parseInt(a.slice(1),10)-parseInt(b.slice(1),10);
    });

    const payload = {
      submitted_at: new Date().toISOString(),
      supervisor,
      programme_level: level(),
      module_code: currentCode,
      outcomes_before: (entry.outcomes || []).slice(),
      outcomes_after: after,
      notes: notesInput.value.trim()
    };

    const fname = `${currentCode}_${payload.programme_level}_outcomes_update_${payload.submitted_at.replaceAll(':','-')}.json`;
    downloadJson(payload, fname);
    statusEl.textContent = `Downloaded: ${fname}`;
  });

  (async function init(){
    try {
      const res = await fetch('./modules_from_module_learning_outcomes.json');
      if (!res.ok) throw new Error(`Failed to load dataset: ${res.status}`);
      const data = await res.json();
      modules = data.modules || {};
      const codes = Object.keys(modules).sort();
      moduleSelect.innerHTML = codes.map(c => `<option value="${c}">${c}</option>`).join('');
      if (!codes.length) throw new Error("No modules found in dataset.");
      renderModule(codes[0]);
      statusEl.textContent = "Loaded dataset.";
    } catch (e) {
      console.error(e);
      statusEl.textContent = e.message;
    }
  })();
</script>
</body>
</html>
